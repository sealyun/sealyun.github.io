<!DOCTYPE html>
<html lang="en-us">
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?2803648cc5852dd3e9e46bbd0bf63366";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

  <head>
  <meta charset="utf-8">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>kubernetes安装常见问题总结</title>
  <meta name="author" content="" />

  
  <meta name="keywords" content="FAQ, How do I, questions, what if">
  

  
  <meta name="description" content="安装常见问题">
  

  <meta name="generator" content="Hugo 0.54.0" />

  <link href='//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800' rel='stylesheet' type='text/css'>

  
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

  
  <link href="/css/animate.css" rel="stylesheet">

  
  
    <link href="/css/style.green.css" rel="stylesheet" id="theme-stylesheet">
  


  
  <link href="/css/custom.css" rel="stylesheet">

  
  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
  <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" href="/img/apple-touch-icon.png" />
  

  <link href="/css/owl.carousel.css" rel="stylesheet">
  <link href="/css/owl.theme.css" rel="stylesheet">

  <link rel="alternate" href="https://sealyun.com/index.xml" type="application/rss+xml" title="SealYun">

  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@GoHugoIO">
  <meta name="twitter:title" content="kubernetes安装常见问题总结">
  <meta name="twitter:image" content="https://sealyun.com/img/twitter-default.png">
  <meta name="twitter:description" content="安装常见问题">

  
  <meta property="og:title" content="kubernetes安装常见问题总结" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://sealyun.com/faq//" />
  <meta property="og:image" content="/img/logo.png" />

</head>


  <body>
      <img src="https://sealyun.com/img/qrcode.png" style="width:140px;position:fixed;right:10px;bottom:10px;z-index:10;"/>
      <img src="https://sealyun.com/img/qrcode1.jpg" style="width:140px;position:fixed;right:10px;bottom:160px;z-index:10;"/>

    <div id="all">

        <header>

          <div class="navbar-affixed-top" data-spy="affix" data-offset-top="200">

    <div class="navbar navbar-default yamm" role="navigation" id="navbar">

        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand home" href="https://sealyun.com/">
                    <img src="https://sealyun.com//img/logo.png" style="width:100px" alt="kubernetes安装常见问题总结 logo" class="hidden-xs hidden-sm">
                    <img src="https://sealyun.com//img/logo-small.png" alt="kubernetes安装常见问题总结 logo" class="visible-xs visible-sm">
                    <span class="sr-only">kubernetes安装常见问题总结 - go to homepage</span>
                </a>
                <div class="navbar-buttons">
                    <button type="button" class="navbar-toggle btn-template-main" data-toggle="collapse" data-target="#navigation">
                      <span class="sr-only">Toggle Navigation</span>
                        <i class="fa fa-align-justify"></i>
                    </button>
                </div>
            </div>
            

            <div class="navbar-collapse collapse" id="navigation">
                <ul class="nav navbar-nav navbar-right">
                  
                  
                  
                  <li class="dropdown">
                    
                    <a href="/">首页</a>
                    
                  </li>
                  
                  
                  <li class="dropdown">
                    
                    <a href="/blog/">博客</a>
                    
                  </li>
                  
                  
                  <li class="dropdown">
                    
                    <a href="http://store.lameleg.com">kubernetes离线安装</a>
                    
                  </li>
                  
                  
                  <li class="dropdown">
                    
                    <a href="https://sealyun.com/blog/2019/04/15/sealos2.0/">安装文档</a>
                    
                  </li>
                  
                  
                  <li class="dropdown">
                    
                    <a href="/faq">常见问题</a>
                    
                  </li>
                  
                  
                  <li class="dropdown">
                    
                    <a href="/changelog">版本变更说明</a>
                    
                  </li>
                  
                </ul>
            </div>
            

            <div class="collapse clearfix" id="search">

                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search">
                        <span class="input-group-btn">

                    <button type="submit" class="btn btn-template-main"><i class="fa fa-search"></i></button>

                </span>
                    </div>
                </form>

            </div>
            

        </div>
    </div>
    

</div>




        </header>

        <div id="heading-breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1>kubernetes安装常见问题总结</h1>
            </div>
        </div>
    </div>
</div>


        <div id="content">
            

            <div class="container">

                <div class="row">

                    <div class="col-md-12">

                        <div>
                          <p><a href="https://github.com/fanux/fanux.github.io/issues/3">https://github.com/fanux/fanux.github.io/issues/3</a></p>

<blockquote>
<p>重启机器kubelet起不来？</p>
</blockquote>

<p>确保selinux swap 已经关闭。     swapoff -a&amp;&amp; setenforce 0&amp;&amp;systemctl start kubelet         执行后会拉起其他服务</p>

<p>永久关闭swap:</p>

<pre><code>1. Identify configured swap devices and files with cat /proc/swaps.
2. Turn off all swap devices and files with swapoff -a.
3. Remove any matching reference found in /etc/fstab
</code></pre>

<p>永久关闭selinux:</p>

<pre><code>vim /etc/sysconfig/selinux SELINUX=enforcing 改为 SELINUX=disabled 
</code></pre>

<blockquote>
<p>chrome 浏览器可能访问不了dashboard</p>
</blockquote>

<p>是因为新版chrome安全检测太严格，不认自签证书，要解决可以使用火狐，或者自己买证书给dashboard配置上。      访问不了dashboard先检查pod有没有启动成功<code>kubectl get pod -n kube-system</code>，再在节点上用curl检查，如果能curl到 那就是浏览器的原因了。注意是https</p>

<p>自己创建证书：</p>

<p>1.用openssl创建证书</p>

<pre><code>$ mkdir certs
$ cd certs
$ openssl genrsa -des3 -passout pass:x -out dashboard.pass.key 2048
$ openssl rsa -passin pass:x -in dashboard.pass.key -out dashboard.key
$ rm dashboard.pass.key
$ openssl req -new -key dashboard.key -out dashboard.csr
$ openssl x509 -req -sha256 -days 365 -in dashboard.csr -signkey dashboard.key -out dashboard.crt
$ rm -rf dashboard.csr
</code></pre>

<p>2.删除dashboard,这个文件在解压包里找
$ kubectl delete -f kubernetes-dashboard.yaml</p>

<p>3.创建kubernetes-dashboard-secret
$ kubectl create secret generic kubernetes-dashboard-certs &ndash;from-file=$HOME/certs -n kube-system</p>

<p>4.创建新的dashboard
$ kubectl create-f kubernetes-dashboard.yaml</p>

<blockquote>
<p>修改calico pod地址段?</p>
</blockquote>

<p><a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/">kubeadm文档</a>  要改两个地方1. kubeadm配置：</p>

<pre><code>networking:
  dnsDomain: &lt;string&gt;
  serviceSubnet: &lt;cidr&gt;
  podSubnet: &lt;cidr&gt;   # 这里
</code></pre>

<ol>
<li>calico yaml配置:</li>
</ol>

<pre><code>    - name: FELIX_DEFAULTENDPOINTTOHOSTACTION
      value: &quot;ACCEPT&quot;
    # Configure the IP Pool from which Pod IPs will be chosen.
    - name: CALICO_IPV4POOL_CIDR
      value: &quot;192.168.122.0/24&quot;   # 这里
    - name: CALICO_IPV4POOL_IPIP
      value: &quot;always&quot;
    # Disable IPv6 on Kubernetes.
    - name: FELIX_IPV6SUPPORT
      value: &quot;false&quot;
</code></pre>

<blockquote>
<p>kubeadm join命令找不到了？</p>
</blockquote>

<p>用这个 kubeadm token create &ndash;print-join-command</p>

<blockquote>
<p>需要通过外网访问APIserver?</p>
</blockquote>

<p>典型场景：通过阿里云floatingIP访问APIserver，这时需要把floatingip加入到证书里面，或者如keepalived的虚拟IP， 修改conf/kubeadm.yaml 加入以下字段：</p>

<pre><code>apiServerCertSANs:
  - 10.100.81.11   // 你的外网IP等
  - master01.bja.paas  //如果通过域名访问也需要加域名
</code></pre>

<p>然后重新init</p>

<p>最后直接修改kubeconfig文件（~/.kube/config）里的IP即可，把这个文件拷贝到本机，就可以通过外网访问apiserver了</p>

<blockquote>
<p>获取登录token:</p>
</blockquote>

<p>admin token:</p>

<pre><code>kubectl describe secret `kubectl get secret |grep cluster-admin|awk '{print $1}'`|grep token|awk '{print $2}'|tail -1
</code></pre>

<p>dashboard service account token:</p>

<pre><code>kubectl get secret $(kubectl get serviceaccount dashboard -o jsonpath=&quot;{.secrets[0].name}&quot;) -o jsonpath=&quot;{.data.token}&quot; | base64 --decode
</code></pre>

<p>或者使用<a href="https://github.com/fanux/fist">fist auth 模块</a></p>

<blockquote>
<p>在这一步卡死，且docker ps没有任何容器起来，但是kubelet正常</p>
</blockquote>

<pre><code>[init] this might take a minute or longer if the control plane images have to be pulled 
</code></pre>

<p>看/var/log/messages有如下日志</p>

<pre><code> RunPodSandbox from runtime service failed: rpc error: code = Unknown desc = failed to create a sandbox for pod &quot;kube-apiserver-istiohost&quot;: Error response from daemon: cgroup-parent for systemd cgroup should be a valid slice named as &quot;xxx.slice&quot;
</code></pre>

<p>这是docker版本与k8s兼容性问题，建议跟换docker版本。  我在1.13.1上出现过此问题,升级到了18.06.0-ce解决，不过具体版本可根据自己需求安装</p>

<p>安装docker-ce:</p>

<pre><code>yum install -y yum-utils
yum-config-manager     --add-repo     https://download.docker.com/linux/centos/docker-ce.repo
yum-config-manager --disable docker-ce-edge
yum makecache fast
yum install docker-ce
</code></pre>

<blockquote>
<p>NodePort无法访问：iptables -P FORWARD ACCEPT</p>

<p>failure loading ca certificate: the certificate is not valid yet</p>
</blockquote>

<p>服务器时间不同步导致</p>

<blockquote>
<p>coredns无法启动</p>
</blockquote>

<pre><code>.:53
2018/09/28 08:45:32 [INFO] CoreDNS-1.2.2
2018/09/28 08:45:32 [INFO] linux/amd64, go1.11, eb51e8b
CoreDNS-1.2.2
linux/amd64, go1.11, eb51e8b
2018/09/28 08:45:32 [INFO] plugin/reload: Running configuration MD5 = f65c4821c8a9b7b5eb30fa4fbc167769
2018/09/28 08:45:38 [FATAL] plugin/loop: Seen &quot;HINFO IN 4443432808327291531.7218519048545008660.&quot; more than twice, loop detected
</code></pre>

<p>修改宿主机的/etc/resolv.conf
内容：</p>

<pre><code>[root@iZrj9aqbeed7la2925ggzaZ ~]# cat /etc/resolv.conf
; generated by /usr/sbin/dhclient-script
nameserver 8.8.8.8
</code></pre>

<p>杀掉DNS pod即可</p>

<blockquote>
<p>calico无法启动</p>
</blockquote>

<pre><code>Readiness probe failed: calico/node is not ready: felix is not ready: Get http://localhost:9099/readiness: dial tcp [::1]:9099: connect: connection refused 
</code></pre>

<p>很可能是网卡发现有问题，calico虚拟化时没找对网卡，calico会经常找docker0网桥，导致clusterIP不通从而calico node连不上etcd</p>

<p>解决办法：
配置好/etc/hosts</p>

<p>或者修改网卡发现机制：
calico网卡发现 conf/net/calico.yaml文件：</p>

<pre><code>- name: IP_AUTODETECTION_METHOD
              value: &quot;interface=eth.*&quot;   # 如果你的网卡不是eth开头，换成自己的，在yaml文件里修改
</code></pre>

<p>还有可能是/etc/resove.conf配置错误，如果里面配置了一些search可能会导致calico无法启动，
解决方法是删除不需要的DNS配置,仅配置：</p>

<pre><code>nameserver 8.8.8.8
</code></pre>

<blockquote>
<p>kubeadm no default route错误</p>
</blockquote>

<p>It picks the interface with the default gateway and listens to that.
所以配置好主机默认路由即可，就是default：</p>

<pre><code>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         169.254.1.1     0.0.0.0         UG    0      0        0 eth1
</code></pre>

<blockquote>
<p>1.14版本join时需要增加一个&ndash;master参数</p>
</blockquote>

<p>为了兼容单master与多master的情况：</p>

<pre><code>kubeadm join 10.103.97.1:6443 --token 9vr73a.a8uxyaju799qwdjv \
    --master 10.103.97.100:6443 \
    --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866
</code></pre>

<blockquote>
<p>1.14以上版本机器重启node节点notready</p>
</blockquote>

<p>这与开机没有加载ipvs内核模块有关，首先请确保ipvs已经加载.
然后确保node kubelet已经正常启动
最后查看lvscare的pod有没有启动
如果都正常还是notready的话，重启lvscare pod即可</p>

<pre><code># Open ipvs
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4

cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl --system
sysctl -w net.ipv4.ip_forward=1
systemctl stop firewalld &amp;&amp; systemctl disable firewalld
swapoff -a
setenforce 0
</code></pre>

<p>可以直接杀lvscare容器，kubelet会自动拉起</p>

<blockquote>
<p>error execution phase preflight: couldn&rsquo;t validate the identity of the API</p>
</blockquote>

<p>可能是token过期，需要在master上重新生成token再join:</p>

<pre><code>kubeadm token create --print-join-command
</code></pre>

<p>用<a href="https://github.com/fanux/sealos">sealos</a>时,join别忘记加 <code>--master</code> 参数<a href="https://github.com/fanux/sealos">参考readme</a></p>

<blockquote>
<p>kubelet能起来但是安装时卡住</p>
</blockquote>

<p>有位朋友centos7.3上安装master时卡住， docker 1.13.1,原因是系统兼容性问题，如果发现安装过程中kubelet已经能起来了，而容器一个没起，可能就是这个原因，
起容器会报这个错：</p>

<pre><code> applying cgroup configuration for process caused \\\&quot;Cannot set property TasksAccounting, or unknown property.
</code></pre>

<p>解决办法：</p>

<pre><code>yum update
</code></pre>

<blockquote>
<p>kubelet起不来</p>
</blockquote>

<p>在有些系统下可能会有这个问题：</p>

<pre><code>Executable path is not absolute: sh /usr/bin/kubelet-pre-start.sh
7月 22 13:59:21 ning systemd[1]: /etc/systemd/system/kubelet.service:7: Executable path is not absolute: sh /usr/bin/kubelet-pre-start.sh
</code></pre>

<p>因为找不到 <code>sh</code>这个命令导致</p>

<p>修改 <code>kube/conf/kubelet.service</code>
把 <code>ExecStartPre=sh</code> 改成 <code>ExecStartPre=/bin/bash</code></p>

<blockquote>
<p>calico无法启动</p>
</blockquote>

<pre><code>[root@k8s03 ~]# kubectl logs calico-node-v4s8w -n kube-system
Error from server (BadRequest): container &quot;calico-node&quot; in pod &quot;calico-node-v4s8w&quot; is waiting to start: PodInitializing
</code></pre>

<pre><code>Unable to update cni config: No networks found in /etc/cni/net.d
</code></pre>

<p>这是由于init container初始化失败， 把正常借点的/etc/cni拷贝到不正常的节点即可.</p>

<blockquote>
<p>prometheus pod都正常就是没监控数据</p>
</blockquote>

<p>可能是服务器时间没同步，同步下时间杀pod即可</p>

<blockquote>
<p>ssh执行失败,no supported methods remain</p>
</blockquote>

<pre><code>Error create ssh session failed ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain
</code></pre>

<p>原因找到，master与node机器密码必须一致，如果使用&ndash;passwd参数的话，密码不一样请使用免密钥，github.com/fanux/sealos/README.md 上有详细说明</p>

<blockquote>
<p>ubuntu kubelet启动不了</p>
</blockquote>

<pre><code>/usr/bin/kubelet-pre-start.sh: 行 17: setenforce: 未找到命   
</code></pre>

<p>因为ubuntu 可能没装setenforce</p>

<pre><code>在/etc/init.d/停止AppArmor脚本：
sudo /etc/init.d/apparmor stop
从系统中清除AppArmor。
apt purge apparmor
如果您担心配置文件被删除，请使用apt remove apparmor。
更新并重新启动系统：
apt update &amp;&amp; upgrade -yuf
reboot
安装SELinux
安装SELinux软件包并重启系统：
apt install selinux
reboot
您可以通过尝试将SELinux设置为enforcing模式来确定SELinux是否在您的系统上强制执行安全性。
root@ubuntu:~# setenforce 1
root@ubuntu:~# getenforce
Enforcing
</code></pre>

<p>或者</p>

<p>如果装不了selinux 就改下压缩包就行，kube/bin/ubelet-pre-start.sh 把这行注释了  然后重新打包。</p>

                        </div>

                    </div>

                </div>
                

            </div>
            

            
        </div>
        

        <footer id="footer">
    <div class="container">

        
        <div class="col-md-4 col-sm-6">
            <h4>About us</h4>

            把我们实践过程中好的东西拿出来给大家复用，收点小费，我们很用心，用我们产品也很值得

            <hr class="hidden-md hidden-lg hidden-sm">

        </div>
        
        

        <div class="col-md-4 col-sm-6">

             
            <h4>Recent posts</h4>

            <div class="blog-entries">
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://sealyun.com/blog/2019/08/03/kustomize/">
                          
                            <img src="https://sealyun.com/img/kustomize.jpeg" class="img-responsive" alt="kustomize 颤抖吧helm!">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://sealyun.com/blog/2019/08/03/kustomize/">kustomize 颤抖吧helm!</a></h5>
                    </div>
                </div>
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://sealyun.com/blog/2019/07/30/cni/">
                          
                            <img src="https://sealyun.com/CNI.png" class="img-responsive" alt="彻底理解 kubernetes CNI">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://sealyun.com/blog/2019/07/30/cni/">彻底理解 kubernetes CNI</a></h5>
                    </div>
                </div>
                
                <div class="item same-height-row clearfix">
                    <div class="image same-height-always">
                        <a href="https://sealyun.com/blog/2019/07/20/crd/">
                          
                            <img src="https://sealyun.com/img/CRD.png" class="img-responsive" alt="kubernetes CRD如此简单">
                          
                        </a>
                    </div>
                    <div class="name same-height-always">
                        <h5><a href="https://sealyun.com/blog/2019/07/20/crd/">kubernetes CRD如此简单</a></h5>
                    </div>
                </div>
                
            </div>

            <hr class="hidden-md hidden-lg">
             

        </div>
        

        
        <div class="col-md-4 col-sm-6">

          <h4>Contact</h4>

            <strong>fhtjob@hotmail.com</strong>
      </p>
      


            <a href="/contact" class="btn btn-small btn-template-main">Go to contact page</a>

            <hr class="hidden-md hidden-lg hidden-sm">

        </div>
        
        

    </div>
    
</footer>







<div id="copyright">
    <div class="container">
        <div class="col-md-12">
            
            <p class="pull-left">Copyright (c) 2015 - 2016, Beiming; all rights reserved.</p>
            
            <p class="pull-right">
              Template by <a href="http://bootstrapious.com/free-templates">Bootstrapious</a>.
              

              Ported to Hugo by <a href="https://github.com/devcows/hugo-universal-theme">DevCows</a>
            </p>
        </div>
    </div>
</div>





    </div>
    

    
<script src="//code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js"></script>

<script src="https://sealyun.com/js/hpneo.gmaps.js"></script>
<script src="https://sealyun.com/js/gmaps.init.js"></script>
<script src="https://sealyun.com/js/front.js"></script>


<script src="https://sealyun.com/js/owl.carousel.min.js"></script>


  </body>
</html>
